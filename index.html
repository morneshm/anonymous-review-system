<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Anonymous Review System ‚Äî Admin Only</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { --bg:#f5f5f5; --card:#fff; --muted:#666; --accent:#2b6cb0; }
    body { font-family: Arial, sans-serif; margin:0; padding:20px; background:var(--bg); color:#111; }
    #app { max-width:900px; margin:auto; background:var(--card); padding:20px; border-radius:10px; }
    header { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; flex-wrap:wrap; }
    nav button { margin-left:8px; padding:8px 14px; cursor:pointer; border-radius:6px; border:1px solid #ccc; background:#fff; }
    textarea { width:100%; min-height:110px; margin-top:10px; padding:10px; border-radius:8px; border:1px solid #ddd; }
    select { padding:8px; border-radius:6px; border:1px solid #ccc; width:100%; margin-top:10px; }
    .btn { padding:10px 14px; border:none; cursor:pointer; border-radius:8px; background:var(--accent); color:#fff; }
    .btn.alt { background:#e6e6e6; color:#111; }
    .review { background:#fafafa; padding:12px; margin-top:10px; border-radius:8px; border:1px solid #eee; }
    .hidden { display:none; }
    .muted { color:var(--muted); }
    input[type=password] { padding:8px; border-radius:6px; border:1px solid #ccc; }
  </style>
</head>
<body>

<div id="app">

  <header>
    <h2>Anonymous Review System</h2>
    <nav>
      <button onclick="showPage('user')">üìù Send Review</button>
      <button onclick="showPage('admin')">üîê Admin</button>
    </nav>
  </header>

  <!-- USER PAGE -->
  <section id="page-user">
    <h3>Send Anonymous Review</h3>
    <p class="muted">Your message is anonymous and sent only to the admin.</p>

    <label>Rating:</label>
    <select id="ratingInput">
      <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (5)</option>
      <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê (4)</option>
      <option value="3">‚≠ê‚≠ê‚≠ê (3)</option>
      <option value="2">‚≠ê‚≠ê (2)</option>
      <option value="1">‚≠ê (1)</option>
    </select>

    <textarea id="reviewInput" placeholder="Write your review..."></textarea>
    <button class="btn" onclick="sendReview()">Send</button>
  </section>

  <!-- ADMIN PAGE -->
  <section id="page-admin" class="hidden">
    <h3>Admin Panel</h3>

    <!-- LOGIN -->
    <div id="adminLogin">
      <div id="setupBox" class="hidden">
        <p>No admin password found. Create one:</p>
        <input id="setupPwd" type="password" placeholder="New password">
        <input id="setupPwd2" type="password" placeholder="Confirm">
        <button class="btn" onclick="completeSetup()">Create Admin Password</button>
      </div>

      <div id="loginBox" class="hidden">
        <p>Enter admin password:</p>
        <input id="loginPwd" type="password" placeholder="Password">
        <button class="btn" onclick="attemptLogin()">Login</button>
        <p id="loginError" class="muted hidden" style="color:red"></p>
      </div>
    </div>

    <!-- ADMIN CONTROLS -->
    <div id="adminControls" class="hidden">
      <button class="btn alt" onclick="refreshInbox()">Refresh</button>
      <button class="btn alt" onclick="exportInbox()">Export CSV</button>
      <button class="btn alt" onclick="clearAll()">Clear All</button>
      <button class="btn alt" onclick="togglePasswordChange()">Change Password</button>
      <button class="btn" onclick="logout()">Logout</button>

      <div id="changePwd" class="hidden" style="margin-top:10px;">
        <input id="oldPwd" type="password" placeholder="Current password">
        <input id="newPwd" type="password" placeholder="New password">
        <input id="newPwd2" type="password" placeholder="Confirm new">
        <button class="btn" onclick="changePassword()">Save</button>
      </div>

      <h4 style="margin-top:20px;">Inbox:</h4>
      <div id="adminInbox"></div>
    </div>

  </section>

</div>

<script>
/* ===== Storage keys ===== */
const KEY_ADMIN_HASH = "adminPasswordHash";
const KEY_INBOX = "adminInbox";
const SESSION = "adminLoggedIn";

/* ===== SHA-256 hashing ===== */
async function sha256(txt) {
  const buf = await crypto.subtle.digest("SHA-256", new TextEncoder().encode(txt));
  return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2,"0")).join("");
}

/* ===== Page switching ===== */
function showPage(p) {
  document.getElementById("page-user").classList.add("hidden");
  document.getElementById("page-admin").classList.add("hidden");
  document.getElementById("page-" + p).classList.remove("hidden");
  if (p === "admin") prepareAdmin();
}

/* ===== User review submission ===== */
function sendReview() {
  let text = reviewInput.value.trim();
  let rating = ratingInput.value;

  if (!text) return alert("Write something first");

  let inbox = JSON.parse(localStorage.getItem(KEY_INBOX) || "[]");
  inbox.unshift({
    id: Date.now(),
    time: new Date().toLocaleString(),
    msg: text,
    rating: rating
  });
  localStorage.setItem(KEY_INBOX, JSON.stringify(inbox));

  reviewInput.value = "";
  ratingInput.value = "5";
  alert("Review sent to admin ‚úî");
}

/* ===== Admin system ===== */
function prepareAdmin() {
  let hash = localStorage.getItem(KEY_ADMIN_HASH);
  let logged = sessionStorage.getItem(SESSION) === "1";

  adminLogin.classList.remove("hidden");
  adminControls.classList.add("hidden");
  setupBox.classList.add("hidden");
  loginBox.classList.add("hidden");

  if (!hash) {
    setupBox.classList.remove("hidden");
  } else if (!logged) {
    loginBox.classList.remove("hidden");
  } else {
    adminLogin.classList.add("hidden");
    adminControls.classList.remove("hidden");
    refreshInbox();
  }
}

/* ===== First-time setup ===== */
async function completeSetup() {
  let p1 = setupPwd.value;
  let p2 = setupPwd2.value;
  if (!p1) return alert("Enter password");
  if (p1 !== p2) return alert("Passwords don't match");

  let hash = await sha256(p1);
  localStorage.setItem(KEY_ADMIN_HASH, hash);
  sessionStorage.setItem(SESSION, "1");
  prepareAdmin();
}

/* ===== Admin login ===== */
async function attemptLogin() {
  let pwd = loginPwd.value;
  let hash = await sha256(pwd);
  let stored = localStorage.getItem(KEY_ADMIN_HASH);

  if (hash === stored) {
    sessionStorage.setItem(SESSION, "1");
    loginPwd.value = "";
    loginError.classList.add("hidden");
    prepareAdmin();
  } else {
    loginError.innerText = "Incorrect password";
    loginError.classList.remove("hidden");
  }
}

/* ===== Inbox display ===== */
function refreshInbox() {
  let data = JSON.parse(localStorage.getItem(KEY_INBOX) || "[]");

  adminInbox.innerHTML = data.length ?
    data.map(r => `
      <div class="review" id="r${r.id}">
        <b>${r.time}</b><br>
        <b>Rating:</b> ${"‚≠ê".repeat(r.rating)}<br><br>
        <p>${r.msg}</p>
        <button class="btn alt" onclick="delReview(${r.id})">Delete</button>
      </div>
    `).join("")
  : "<p class='muted'>No reviews yet</p>";
}

/* ===== Delete single review ===== */
function delReview(id) {
  if (!confirm("Delete this review?")) return;
  let data = JSON.parse(localStorage.getItem(KEY_INBOX));
  data = data.filter(r => r.id !== id);
  localStorage.setItem(KEY_INBOX, JSON.stringify(data));
  refreshInbox();
}

/* ===== Clear all reviews ===== */
function clearAll() {
  if (!confirm("Clear ALL reviews?")) return;
  localStorage.setItem(KEY_INBOX, "[]");
  refreshInbox();
}

/* ===== Export CSV ===== */
function exportInbox() {
  let arr = JSON.parse(localStorage.getItem(KEY_INBOX) || "[]");
  if (!arr.length) return alert("Nothing to export");

  let csv = "id,time,rating,message\n" +
    arr.map(r => `${r.id},"${r.time}",${r.rating},"${r.msg.replace(/"/g, '""')}"`).join("\n");

  let blob = new Blob([csv], { type: "text/csv" });
  let url = URL.createObjectURL(blob);

  let a = document.createElement("a");
  a.href = url;
  a.download = "reviews.csv";
  a.click();
  URL.revokeObjectURL(url);
}

/* ===== Logout ===== */
function logout() {
  sessionStorage.removeItem(SESSION);
  prepareAdmin();
}

/* ===== Password change ===== */
function togglePasswordChange() {
  changePwd.classList.toggle("hidden");
}

async function changePassword() {
  let old = oldPwd.value;
  let n1 = newPwd.value;
  let n2 = newPwd2.value;

  if (!old || !n1) return alert("Fill all fields");
  if (n1 !== n2) return alert("New passwords don't match");

  let oldHash = await sha256(old);
  let stored = localStorage.getItem(KEY_ADMIN_HASH);

  if (oldHash !== stored) return alert("Old password wrong");

  let newHash = await sha256(n1);
  localStorage.setItem(KEY_ADMIN_HASH, newHash);

  oldPwd.value = newPwd.value = newPwd2.value = "";
  changePwd.classList.add("hidden");
  alert("Password changed ‚úî");
}
</script>

</body>
</html>